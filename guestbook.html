<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>방명록</title>
    <style>
        .guest-book {
            width: 1300px;
            height: 600px;
            border: 3px solid black;
            box-shadow: 20px 10px;
            margin: 420px 20px 50px;
            background-color: #FFD0A1;
            list-style-type: none;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            
        }
        
        .message {
           font-size: 30px;
           text-align: center;
        }
        
        .post {
            background-color: white;
            border: 3px solid black;
            width: 95%;
            height: auto;
            box-shadow: 10px 10px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .post p {
            margin: 10px 10px;
        }
        
        .showbtn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #F6DF67;
            border: 2px solid black;
            box-shadow: 2px 2px;
            color: #333;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: bold;
            border-radius: 5px;
            transition: transform 0.2s;
            margin-bottom: 20px;
            margin-top: 20px;
        }
        .btn:hover {
            transform: translateY(-3px);
        }
        
        .user {
            float: left;
            font-weight: bold;
        }
        
        .date {
            text-align: right;
        }
        
        .entry-form {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background-color: #F2F2F2;
            border: 3px solid black;
            width: 1200px;
            box-shadow: 10px 10px;
            margin: 50px;
        }
        
        .entry-form .user {
            padding: 10px 20px;
            background-color: white;
            border: 3px solid black;
            box-shadow: 2px 2px;
            color: #333;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }
        
        .entry-form .explain {
            width: 90%;
            height: 100px;
            margin-bottom: 10px;
            background-color: white;
            border: 3px solid black;
            box-shadow: 2px 2px;
            padding: 10px 20px;
        }
        
        .submitbtn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #F6DF67;
            border: 2px solid black;
            box-shadow: 2px 2px;
            color: #333;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: bold;
            border-radius: 5px;
            transition: transform 0.2s;
            margin-bottom: 20px;
            
            
        }
        
        .delete-btn {
            background-color: #F26767;
            border: 2px solid black;
            box-shadow: 2px 2px;
            color: #333;
            text-decoration: none;
            text-transform: uppercase;
            font-weight: bold;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            transition: transform 0.2s;
            float: right;
            margin-top: -25px;
        }
        
        .delete-btn:hover {
            transform: translateY(-3px);
        }
    </style>
</head>

<body>
    <div class="guest-book" id="guestBook">
        <div class="message">3조에게 응원의 한마디 남겨주세요!</div>
        <div id ="btnbtn"></div>
        <button class="showbtn" id="showEntryForm">방명록 작성하기</button>
       
    </div>

    

    <!-- 방명록 작성 폼 -->
    <div class="entry-form" id="entryForm" style="display: none;">
        <h2>방명록 작성하기</h2>
        <form id="submitForm">
            <input class="user" type="text" name="username" placeholder="닉네임을 입력하세요."><br>
            <textarea class="explain" name="message" placeholder="메시지를 입력하세요."></textarea><br>
            <input class="submitbtn" type="submit" value="등록하기">
        </form>
    </div>
    

    <!-- Firebase 스크립트 -->
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script>
        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyCzNxdnZKBGObRbWt5gML4QxE-Q_vF5y_k",
            authDomain: "zusizo-web-site.firebaseapp.com",
            projectId: "zusizo-web-site",
            storageBucket: "zusizo-web-site.appspot.com",
            messagingSenderId: "68338919855",
            appId: "1:68338919855:web:8f35ce792e8fe33547e75a",
            measurementId: "G-TL8B0BGMG5",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 방명록 작성하기 버튼 클릭 시 폼 보이기/감추기
        document.getElementById('showEntryForm').addEventListener('click', function () {
            var form = document.getElementById('entryForm');
            if (form.style.display === 'none') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        });

        // Firebase에서 방명록 데이터 가져오기 및 실시간 업데이트
        db.collection("guest-book")
            .onSnapshot((snapshot) => {
                const guestBook = document.getElementById("guestBook");
                const guestBookhi = document.createElement("div"); //
        
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        // 추가된 데이터 처리
                        const post = change.doc.data();
                        const li = document.createElement("li");
                        li.id = change.doc.id;
                        li.classList.add("post");
                        // 사용자, 날짜, 설명 요소 생성 및 추가
                        const userNameElement = document.createElement("p");
                        userNameElement.classList.add("user");
                        userNameElement.textContent = post["username"];
                        li.appendChild(userNameElement);

                        const dateElement = document.createElement("p");
                        dateElement.classList.add("date");
                        const datetime = new Date(post["date"]["seconds"] * 1000);
                        const year = datetime.getFullYear();
                        const month = datetime.getMonth() + 1;
                        const date = datetime.getDate();
                        let hours = datetime.getHours();
                        if (hours === 0) {
                            hours = 24;
                        } else if (hours > 24) {
                            hours -= 12;
                        }
                        const minutes = datetime.getMinutes().toString().padStart(2, '0');
                        const ampm = hours >= 12 ? '오후' : '오전';
                        const timeString = `${ampm} ${hours}:${minutes}`;
                        dateElement.textContent = `${year}년 ${month}월 ${date}일 ${timeString}`;
                        li.appendChild(dateElement);

                        const descriptionElement = document.createElement("p");
                        descriptionElement.classList.add("explain");
                        descriptionElement.textContent = post["description"];
                        li.appendChild(descriptionElement);

                        // 삭제 버튼 추가
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = '삭제';
                        deleteBtn.classList.add('delete-btn');
                        deleteBtn.addEventListener('click', function () {
                            // 방명록 삭제 기능 구현
                            const postId = change.doc.id;
                            db.collection("guest-book").doc(postId).delete()
                                .then(() => {
                                    console.log("Document successfully deleted!");
                                })
                                .catch((error) => {
                                    console.error("Error deleting document: ", error);
                                });
                        });

                        // 삭제 버튼 요소를 포스트에 추가
                        li.appendChild(deleteBtn);

                        // 포스트를 게스트북에 추가
                        guestBook.appendChild(li);

                        guestBookhi.appendChild(li); //

                    } else if (change.type === "removed") {
                        // 삭제된 데이터 처리
                        const postId = change.doc.id;
                        const postElement = document.getElementById(postId);
                        if (postElement) {
                            postElement.remove();
                        }
                    }
                });

                newDiv.appendChild(guestBookhi);////
            });
            const newDiv = document.getElementById("btnbtn");
            newDiv.innerHTML = "";

        // 방명록 작성 폼 제출 시 처리
        document.getElementById('submitForm').addEventListener('submit', function (event) {
            event.preventDefault(); // 폼의 기본 동작 중단

            const username = this.querySelector('input[name="username"]').value;
            const message = this.querySelector('textarea[name="message"]').value;
            const today = new Date();
            const date = `${today.getFullYear()}년 ${today.getMonth() + 1}월 ${today.getDate()}일`;

            // Firebase에 방명록 데이터 추가
            db.collection("guest-book").add({
                username: username,
                description: message,
                date: new Date(),
            })
                .then((docRef) => {
                    console.log("Document written with ID: ", docRef.id);
                })
                .catch((error) => {
                    console.error("Error adding document: ", error);
                });

            // 폼 초기화
            this.reset();

            // 폼 닫기
            document.getElementById('entryForm').style.display = 'none';
        });
    </script>
</body>

</html>
